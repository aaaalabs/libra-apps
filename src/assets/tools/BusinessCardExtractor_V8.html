<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Lead Extractor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #5a67d8;
            background: #eef2ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #4a5568;
            margin-bottom: 1rem;
        }

        .upload-subtext {
            color: #718096;
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        .camera-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 1rem 0;
            transition: background 0.3s ease;
        }

        .camera-btn:hover {
            background: #5a67d8;
        }

        .preview-container {
            margin-top: 2rem;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .processing {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-section {
            display: none;
            margin-top: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .success-message, .error-message {
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: none;
        }

        .success-message {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1.5rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Business Card Extractor</h1>
            <p>Wandeln Sie Visitenkarten automatisch in Leads um</p>
        </div>

        <div class="card">
            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Visitenkarte fotografieren oder hochladen</div>
                    <div class="upload-subtext">JPG, PNG oder WEBP bis 10MB</div>
                </div>

                <input type="file" id="fileInput" accept="image/*" capture="environment">

                <div style="text-align: center;">
                    <button class="camera-btn" onclick="openCamera()">üì∏ Kamera √∂ffnen</button>
                </div>

                <div class="preview-container" id="previewContainer"></div>
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p>Verarbeite Visitenkarte mit AI...</p>
            </div>

            <div class="form-section" id="formSection">
                <h3 style="margin-bottom: 1rem; color: #4a5568;">Extrahierte Daten √ºberpr√ºfen</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="company">Firma *</label>
                        <input type="text" id="company" required>
                    </div>

                    <div class="form-group">
                        <label for="contact">Kontakt *</label>
                        <input type="text" id="contact" required>
                    </div>

                    <div class="form-group">
                        <label for="position">Position</label>
                        <input type="text" id="position">
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label for="phone">Telefon</label>
                        <input type="tel" id="phone">
                    </div>

                    <div class="form-group">
                        <label for="industry">Branche</label>
                        <input type="text" id="industry">
                    </div>
                </div>

                <div class="form-group">
                    <label for="painPoint">Energiekosten Pain Point</label>
                    <textarea id="painPoint" placeholder="AI-generierte Einsch√§tzung der Energiekosten-Herausforderungen..."></textarea>
                </div>

                <div class="form-group">
                    <label for="offering">EEG L√∂sungsansatz</label>
                    <textarea id="offering" placeholder="Vorgeschlagener EEG-Ansatz f√ºr dieses Unternehmen..."></textarea>
                </div>

                <div class="form-group">
                    <label for="eventSource">Event/Quelle</label>
                    <input type="text" id="eventSource" placeholder="z.B. Wirtschaftskammer Networking, Energie Expo 2024...">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="resetForm()">Neu starten</button>
                    <button class="btn btn-primary" onclick="saveLead()">üíæ Lead speichern</button>
                </div>

                <!-- Follow-up Email Section (shown after successful save) -->
                <div id="followUpSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
                    <h3 style="margin-bottom: 1rem; color: #4a5568;">üöÄ Direktes Follow-up</h3>
                    <p style="margin-bottom: 1rem; color: #718096;">
                        Senden Sie jetzt eine personalisierte Follow-up Email mit Google Calendar Buchungslink f√ºr ein kostenloses AI-Audit.
                    </p>
                    <div class="action-buttons" style="margin-top: 0;">
                        <button class="btn btn-primary" onclick="sendFollowUpEmail()" id="followUpEmailBtn">
                            üìß Follow-up Email senden
                        </button>
                        <button class="btn btn-secondary" onclick="previewFollowUpEmail()" id="previewEmailBtn">
                            üëÅÔ∏è Email-Vorschau
                        </button>
                    </div>
                </div>
            </div>

            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <script>
        const GROQ_API_KEY = prompt("Enter your Groq API Key:", "") || "your-groq-api-key-here";
        const RESEND_API_KEY = "re_FiRaAbLp_EYaCJWz2rMPno6xc88Ugh4KM"; // For API authentication
        let currentImageData = null;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processImage(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processImage(files[0]);
            }
        }

        function openCamera() {
            // For mobile devices, this will open the camera
            const input = document.getElementById('fileInput');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        async function processImage(file) {
            // Validate file
            if (!file.type.startsWith('image/')) {
                showError('Bitte w√§hlen Sie eine Bilddatei aus.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('Datei ist zu gro√ü. Maximum 10MB.');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = `<img src="${e.target.result}" alt="Business Card Preview" class="preview-image">`;
                currentImageData = e.target.result;
            };
            reader.readAsDataURL(file);

            // Show processing
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processing').style.display = 'block';

            try {
                // Convert to base64 for API
                const base64 = await fileToBase64(file);

                // Call Groq Vision API
                const extractedData = await extractBusinessCardData(base64);

                // Populate form
                populateForm(extractedData);

                // Show form
                document.getElementById('processing').style.display = 'none';
                document.getElementById('formSection').style.display = 'block';

            } catch (error) {
                console.error('Error processing image:', error);
                document.getElementById('processing').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                showError('Fehler beim Verarbeiten der Visitenkarte: ' + error.message);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove data:image/jpeg;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function extractBusinessCardData(base64Image) {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: "meta-llama/llama-4-scout-17b-16e-instruct",
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: `Analysiere diese Visitenkarte und extrahiere die folgenden Informationen. Wenn Informationen fehlen, lass sie leer. Gib das Ergebnis als JSON zur√ºck:

{
  "company": "Firmenname",
  "contact": "Vor- und Nachname der Person",
  "position": "Jobtitel/Position",
  "email": "Email-Adresse",
  "phone": "Telefonnummer (formatiert f√ºr √ñsterreich)",
  "industry": "Gesch√§tzte Branche basierend auf Firma/Titel",
  "painPoint": "Gesch√§tzte Energiekosten-Herausforderungen f√ºr diese Branche (2-3 S√§tze auf Deutsch)",
  "offering": "Vorgeschlagener EEG/Energiegemeinschaft-Ansatz f√ºr dieses Unternehmen (2-3 S√§tze auf Deutsch)"
}

Beantworte NUR mit dem JSON, ohne weitere Erkl√§rungen.`
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64Image}`
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.1
                })
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Groq API Fehler: ${response.status} - ${error}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;

            try {
                // Try to parse JSON response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('Keine g√ºltige JSON-Antwort erhalten');
                }
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                console.error('Raw content:', content);
                throw new Error('Fehler beim Parsen der AI-Antwort');
            }
        }

        function populateForm(data) {
            document.getElementById('company').value = data.company || '';
            document.getElementById('contact').value = data.contact || '';
            document.getElementById('position').value = data.position || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('industry').value = data.industry || '';
            document.getElementById('painPoint').value = data.painPoint || '';
            document.getElementById('offering').value = data.offering || '';
        }

        async function saveLead() {
            // Validate required fields
            const company = document.getElementById('company').value.trim();
            const contact = document.getElementById('contact').value.trim();

            if (!company || !contact) {
                showError('Firma und Kontakt sind Pflichtfelder.');
                return;
            }

            const leadData = {
                id: generateId(),
                company: company,
                contact: contact,
                position: document.getElementById('position').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                industry: document.getElementById('industry').value.trim(),
                painPoint: document.getElementById('painPoint').value.trim(),
                offering: document.getElementById('offering').value.trim(),
                source: `${document.getElementById('eventSource').value || 'Unbekannt'} (via BC OCR)`,
                energyInterest: 'high',
                status: 'new',
                priority: 'medium',
                firstContact: new Date().toISOString().split('T')[0],
                nextFollowupDate: getNextWeekDate(),
                followupAction: 'EEG Beratungstermin anbieten',
                followupPriority: 'important',
                notes: 'Automatisch aus Visitenkarte extrahiert'
            };

            // Show sync status
            showInfo('Synchronisiere mit Redis...');

            try {
                const uploadResult = await saveToLocalStorage(leadData);

                showSuccess(`‚úÖ Lead "${contact}" von ${company} erfolgreich gespeichert!
                           <br>üìä Gesamt-Leads jetzt: <strong>${uploadResult.totalLeads}</strong>
                           <br>üîÑ Redis sync: <strong>${uploadResult.redisSuccess ? 'Erfolgreich' : 'Fehlgeschlagen'}</strong>`);

                // Show follow-up email section if email is available
                if (leadData.email && leadData.email.includes('@')) {
                    showFollowUpSection(leadData);
                } else {
                    // Reset form after 3 seconds if no email for follow-up
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                }

            } catch (error) {
                console.error('Error saving lead:', error);

                // Check if this is a fallback success with Redis failure
                if (error.uploadResult && error.uploadResult.success && !error.uploadResult.redisSuccess) {
                    showSuccess(`‚ö†Ô∏è Lead "${contact}" von ${company} lokal gespeichert!
                               <br>üìä Gesamt-Leads jetzt: <strong>${error.uploadResult.totalLeads}</strong>
                               <br>üîÑ Redis sync: <strong>Fehlgeschlagen</strong> (wird sp√§ter nachgeholt)
                               <br><br>N√§chster Schritt: Pers√∂nliche Nachricht mit EEG-Mehrwert senden.`);
                } else {
                    showError('Fehler beim Speichern: ' + error.message);
                }
            }
        }

        async function saveToLocalStorage(leadData) {
            let redisSuccess = false;
            let totalLeads = 0;

            try {
                // Step 1: Download current data from Redis
                console.log('Downloading current leads from Redis...');
                const currentData = await downloadFromRedis();

                const oldLeadCount = currentData.leads.length;

                // Step 2: Add new lead to existing data
                console.log('Adding new lead to existing data...');
                const now = new Date().toISOString();
                currentData.leads.push(leadData);
                currentData.settings.dataVersion = Date.now();
                currentData.settings.lastBackup = now;

                totalLeads = currentData.leads.length;

                // Step 3: Upload updated data back to Redis
                console.log('Uploading updated data to Redis...');
                const uploadResponse = await uploadToRedis(currentData);
                redisSuccess = true;

                // Step 4: Also save to localStorage for offline access
                localStorage.setItem('libra-leads', JSON.stringify(currentData));

                console.log('‚úÖ Lead successfully saved:', {
                    oldCount: oldLeadCount,
                    newCount: totalLeads,
                    addedLeads: totalLeads - oldLeadCount,
                    redisSync: 'SUCCESS',
                    leadId: leadData.id,
                    company: leadData.company
                });

                return {
                    success: true,
                    redisSuccess: true,
                    totalLeads: totalLeads,
                    leadChange: totalLeads - oldLeadCount,
                    uploadResponse
                };

            } catch (error) {
                console.error('‚ùå Redis sync failed, falling back to localStorage only:', error);

                // Fallback: Save only to localStorage
                const localData = JSON.parse(localStorage.getItem('libra-leads') || '{"leads": [], "settings": {}}');
                const oldLocalCount = localData.leads.length;

                const fallbackTime = new Date().toISOString();
                localData.leads.push(leadData);
                localData.settings.dataVersion = Date.now();
                localData.settings.lastBackup = fallbackTime;
                localStorage.setItem('libra-leads', JSON.stringify(localData));

                totalLeads = localData.leads.length;

                console.log('üíæ Fallback save successful:', {
                    oldCount: oldLocalCount,
                    newCount: totalLeads,
                    redisSync: 'FAILED',
                    localSave: 'SUCCESS',
                    error: error.message
                });

                return {
                    success: true,
                    redisSuccess: false,
                    totalLeads: totalLeads,
                    leadChange: totalLeads - oldLocalCount,
                    error: error.message
                };
            }
        }

        async function downloadFromRedis() {
            // Using the same Upstash Redis as LibraLeads main system
            const REDIS_CONFIG = {
                restUrl: 'https://prime-lacewing-62247.upstash.io',
                token: 'AfMnAAIncDE2ZDgzMGQ1ZDhlMDE0NjczYWIyOTkzMTM2YjU2ZTY4MXAxNjIyNDc',
                hashKey: 'lib:leads'
            };

            const response = await fetch(`${REDIS_CONFIG.restUrl}/hmget/${REDIS_CONFIG.hashKey}/leads_data/metadata/lastBackup/backupInterval`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${REDIS_CONFIG.token}`,
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                // If Redis GET fails, try to get from localStorage as fallback
                console.warn('Redis download failed, using localStorage as base');
                const fallbackData = JSON.parse(localStorage.getItem('libra-leads') || '{"leads": [], "settings": {}}');
                if (!fallbackData.settings) fallbackData.settings = {};
                if (!fallbackData.settings.dataVersion) fallbackData.settings.dataVersion = Date.now();
                if (!fallbackData.settings.lastBackup) fallbackData.settings.lastBackup = new Date().toISOString();
                return fallbackData;
            }

            const responseData = await response.json();
            const values = responseData.result || [];

            try {
                // Parse the retrieved Redis hash data (same format as LibraLeads)
                const leads = JSON.parse(values[0] || '[]');
                const metadata = JSON.parse(values[1] || '{}');
                const lastBackup = values[2];
                const backupInterval = values[3];

                const parsedData = {
                    leads: leads,
                    settings: {
                        dataVersion: metadata.version,
                        lastBackup: lastBackup,
                        backupInterval: backupInterval
                    },
                    metadata: metadata
                };

                console.log('üì• BCE: Downloaded from Redis:', {
                    leadsCount: leads.length,
                    dataVersion: metadata.version,
                    lastBackup: lastBackup
                });

                return parsedData;

            } catch (parseError) {
                console.error('Error parsing Redis data:', parseError);
                // Fallback to localStorage
                const fallbackData = JSON.parse(localStorage.getItem('libra-leads') || '{"leads": [], "settings": {}}');
                if (!fallbackData.settings) fallbackData.settings = {};
                if (!fallbackData.settings.dataVersion) fallbackData.settings.dataVersion = Date.now();
                if (!fallbackData.settings.lastBackup) fallbackData.settings.lastBackup = new Date().toISOString();
                return fallbackData;
            }
        }

        async function uploadToRedis(data) {
            // Using the same Upstash Redis as LibraLeads main system
            const REDIS_CONFIG = {
                restUrl: 'https://prime-lacewing-62247.upstash.io',
                token: 'AfMnAAIncDE2ZDgzMGQ1ZDhlMDE0NjczYWIyOTkzMTM2YjU2ZTY4MXAxNjIyNDc',
                hashKey: 'lib:leads'
            };

            // Create comprehensive metadata like LibraLeads main system
            const now = new Date().toISOString();
            const metadata = {
                version: data.settings.dataVersion || Date.now(),
                exportDate: now,
                totalLeads: data.leads?.length || 0,
                format: 'LibraLeads',
                source: 'Business Card OCR',
                syncedAt: now,
                lastModified: data.settings.lastBackup || now
            };

            // Create hashData structure that matches LibraLeads format exactly
            const hashData = {
                leads_data: JSON.stringify(data.leads),
                metadata: JSON.stringify(metadata),
                lastBackup: data.settings.lastBackup || now,
                backupInterval: data.settings.backupInterval || 'daily'
            };

            console.log('üì§ BCE: Uploading to Redis with metadata:', {
                leadsCount: data.leads?.length || 0,
                dataVersion: metadata.version,
                lastBackup: hashData.lastBackup,
                redisEndpoint: REDIS_CONFIG.restUrl
            });

            // Set each field individually using HSET (same method as LibraLeads)
            const results = [];
            for (const [field, value] of Object.entries(hashData)) {
                const encodedKey = encodeURIComponent(REDIS_CONFIG.hashKey);
                const encodedField = encodeURIComponent(field);
                const encodedValue = encodeURIComponent(value);

                const url = `${REDIS_CONFIG.restUrl}/hset/${encodedKey}/${encodedField}/${encodedValue}`;

                console.log(`üì§ BCE: Setting Redis field '${field}' to URL:`, url.substring(0, 100) + '...');

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${REDIS_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå Redis HSET failed for field '${field}':`, response.status, errorText);
                    throw new Error(`Redis HSET failed for field '${field}': ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                results.push({ field, result });

                console.log(`‚úÖ BCE: Redis field '${field}' set:`, result);
            }

            const finalResult = { success: true, fieldsUpdated: results.length, results };

            console.log('‚úÖ BCE: Redis upload successful:', {
                finalResult,
                fieldsUpdated: finalResult.fieldsUpdated,
                results: finalResult.results,
                leadsCount: data.leads?.length || 0
            });

            return finalResult;
        }

        function generateId() {
            return 'bc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getNextWeekDate() {
            const date = new Date();
            date.setDate(date.getDate() + 7);
            return date.toISOString().split('T')[0];
        }

        function resetForm() {
            // Hide messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // Reset sections
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processing').style.display = 'none';
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('followUpSection').style.display = 'none'; // Hide follow-up section

            // Clear preview
            document.getElementById('previewContainer').innerHTML = '';

            // Clear form
            document.getElementById('fileInput').value = '';
            const inputs = document.querySelectorAll('#formSection input, #formSection textarea');
            inputs.forEach(input => input.value = '');

            // Reset image data and lead data
            currentImageData = null;
            currentLeadData = null;
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.innerHTML = message;
            successEl.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showInfo(message) {
            const successEl = document.getElementById('successMessage');
            successEl.innerHTML = `‚è≥ ${message}`;
            successEl.style.display = 'block';
            successEl.style.background = '#e6f3ff';
            successEl.style.color = '#1a365d';
            successEl.style.border = '1px solid #90cdf4';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Global variable to store current lead data for follow-up
        let currentLeadData = null;

        // Show follow-up email section after successful lead save
        function showFollowUpSection(leadData) {
            currentLeadData = leadData;
            const followUpSection = document.getElementById('followUpSection');
            followUpSection.style.display = 'block';

            // Smooth scroll to follow-up section
            followUpSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Preview follow-up email content
        function previewFollowUpEmail() {
            if (!currentLeadData) {
                showError('Keine Lead-Daten verf√ºgbar f√ºr Email-Vorschau');
                return;
            }

            const emailContent = generateEmailTemplate(currentLeadData);

            // Create modal-like preview
            const preview = `
                <div style="background: #f8f9ff; padding: 1.5rem; border-radius: 8px; border: 2px solid #667eea; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: #4a5568;">üìß Email-Vorschau</h4>
                    <div style="background: white; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                        <strong>An:</strong> ${currentLeadData.email}<br>
                        <strong>Betreff:</strong> ${emailContent.subject}<br><br>
                        <div style="white-space: pre-line; color: #2d3748;">${emailContent.text}</div>
                    </div>
                    <button onclick="closeEmailPreview()" style="margin-top: 1rem; padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">Schlie√üen</button>
                </div>
            `;

            // Show preview below success message
            const successEl = document.getElementById('successMessage');
            successEl.innerHTML += preview;
        }

        // Close email preview
        function closeEmailPreview() {
            // Remove preview by regenerating success message
            if (currentLeadData) {
                showSuccess(`‚úÖ Lead "${currentLeadData.contact}" von ${currentLeadData.company} erfolgreich gespeichert!`);
            }
        }

        // Generate simple preview template (full personalization happens on server)
        function generateEmailTemplate(data) {
            const { company, contact, position, email, industry, painPoint, offering, eventSource } = data;

            const eventRef = eventSource && eventSource !== 'Unbekannt'
                ? `auf dem ${eventSource} Event`
                : 'neulich';

            const subject = `Danke f√ºr deine Visitenkarte, ${contact}!`;

            const text = `Hallo ${contact},

danke f√ºr deine Visitenkarte - war echt cool, dich ${eventRef} kennenzulernen!

[Hier wird eine personalisierte Frage von Groq AI generiert, basierend auf:
- Firma: ${company}
- Branche: ${industry || 'unbekannt'}
- Position: ${position || 'unbekannt'}
- Herausforderung: ${painPoint || 'keine spezifische'}]

Falls du Lust auf ein kurzes Gespr√§ch hast, k√∂nnen wir gerne mal 30 Minuten √ºber KI-Automatisierung oder Energiekosten-Optimierung reden. V√∂llig unverbindlich nat√ºrlich.

Hier kannst du dir direkt einen Termin schnappen:
https://calendar.app.google/kaiLGwT3jUupcD5j7

Oder einfach kurz anrufen/WhatsApp: 0660 1238172

Liebe Gr√º√üe aus Tirol,
Thomas

--
Thomas Seiger
Libra Innovation FlexCo
üìß thomas@libralab.at
üì± 0660 1238172 (auch WhatsApp)
üåê libralab.ai`;

            return { subject, text };
        }

        // Send follow-up email via API
        async function sendFollowUpEmail() {
            if (!currentLeadData) {
                showError('Keine Lead-Daten verf√ºgbar f√ºr Email-Versand');
                return;
            }

            const followUpBtn = document.getElementById('followUpEmailBtn');
            const originalText = followUpBtn.innerHTML;

            // Show loading state
            followUpBtn.innerHTML = '‚è≥ Sende Email...';
            followUpBtn.disabled = true;

            try {
                console.log('üìß Sending follow-up email for:', {
                    contact: currentLeadData.contact,
                    company: currentLeadData.company,
                    email: currentLeadData.email,
                    hasEventSource: !!currentLeadData.eventSource
                });

                // Validate currentLeadData before sending
                if (!currentLeadData.email || !currentLeadData.email.includes('@')) {
                    throw new Error('Ung√ºltige Email-Adresse');
                }

                const requestBody = {
                    leadData: {
                        ...currentLeadData,
                        // Ensure all fields are strings to avoid JSON issues
                        company: String(currentLeadData.company || ''),
                        contact: String(currentLeadData.contact || ''),
                        email: String(currentLeadData.email || ''),
                        eventSource: String(currentLeadData.eventSource || '')
                    }
                };

                console.log('üì¶ Request body:', JSON.stringify(requestBody, null, 2).substring(0, 300) + '...');

                // Call the LibraLab API endpoint with authentication
                const response = await fetch('https://libralab.ai/api/send-follow-up', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${RESEND_API_KEY}`, // API authentication
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì¨ API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ API Response:', result);

                if (result.success) {
                    showSuccess(`‚úÖ Freundschaftliche Follow-up Email gesendet an ${currentLeadData.contact}!
                               <br>üìß Email: ${currentLeadData.email}
                               <br>ü§ñ Mit personalisierter AI-generierter Frage
                               <br>üóìÔ∏è Google Calendar + WhatsApp Kontakt √ºbermittelt
                               <br><br>N√§chster Schritt: Warten auf Antwort oder Terminbuchung.`);

                    // Hide follow-up section and reset after success
                    setTimeout(() => {
                        resetForm();
                    }, 5000);
                } else {
                    throw new Error(result.error || 'Unbekannter Fehler');
                }

            } catch (error) {
                console.error('Email sending failed:', error);
                showError(`Fehler beim Email-Versand: ${error.message}. Bitte versuchen Sie es sp√§ter erneut oder senden Sie die Email manuell.`);
            } finally {
                // Reset button state
                followUpBtn.innerHTML = originalText;
                followUpBtn.disabled = false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Business Card Extractor ready');
        });
    </script>
</body>
</html>